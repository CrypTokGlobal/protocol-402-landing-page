
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Download Verification - Protocol 402</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    .test-container { background: white; padding: 20px; border-radius: 8px; max-width: 800px; margin: 0 auto; }
    .test-button { background: #8B0000; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
    .test-button:hover { background: #A0001C; }
    .status { padding: 15px; margin: 10px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .log { background: #f8f8f8; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto; font-size: 12px; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üî¨ Protocol 402 PDF Verification System</h1>
    <p><strong>CRITICAL:</strong> This page verifies PDF download functionality for the billion-dollar SCETA project.</p>
    
    <div class="status error">
      <strong>DETECTED ISSUE:</strong> PDF file is 0KB (empty). This will cause download failures.
    </div>
    
    <button class="test-button" onclick="verifyPDF()">üîç Verify PDF Status</button>
    <button class="test-button" onclick="testDownload()">üì• Test Download</button>
    <button class="test-button" onclick="testFormSubmission()">üìù Test Form + Download</button>
    <button class="test-button" onclick="clearLog()">üßπ Clear Log</button>
    
    <div id="results"></div>
    <div id="log" class="log">üìã Verification log will appear here...<br></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toISOString();
      const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìã';
      logDiv.innerHTML += `[${timestamp}] ${icon} ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function updateResults(html) {
      document.getElementById('results').innerHTML = html;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = 'üìã Verification log cleared...<br>';
      document.getElementById('results').innerHTML = '';
    }

    async function verifyPDF() {
      log('üîç Starting comprehensive PDF verification...', 'info');
      
      try {
        // Check server PDF status
        const verifyResponse = await fetch('/verify-pdf');
        const verifyData = await verifyResponse.json();
        
        log(`üìä Server PDF Status: ${JSON.stringify(verifyData.pdfStatus)}`, 'info');
        
        if (verifyData.pdfStatus.isEmpty) {
          log('‚ùå CRITICAL: PDF file is empty (0KB)', 'error');
          updateResults('<div class="status error"><strong>CRITICAL ERROR:</strong> PDF file is empty and will not download.</div>');
          return;
        }
        
        if (verifyData.pdfStatus.isSuspiciouslySmall) {
          log(`‚ö†Ô∏è WARNING: PDF is only ${verifyData.pdfStatus.sizeKB}KB - may be corrupted`, 'warning');
        }
        
        // Test HTTP HEAD request
        const headResponse = await fetch('/whitepaper.pdf', { method: 'HEAD' });
        const contentLength = headResponse.headers.get('content-length');
        const size = contentLength ? Math.round(contentLength / 1024) + 'KB' : 'Unknown';
        
        if (headResponse.ok && contentLength && parseInt(contentLength) > 0) {
          log(`‚úÖ PDF HTTP check passed - Size: ${size}`, 'success');
          updateResults(`<div class="status success"><strong>PDF VERIFIED:</strong> File exists and is ${size}</div>`);
        } else {
          log(`‚ùå PDF HTTP check failed - Status: ${headResponse.status}`, 'error');
          updateResults('<div class="status error"><strong>HTTP ERROR:</strong> PDF not accessible via HTTP.</div>');
        }
        
      } catch (error) {
        log(`‚ùå PDF verification error: ${error.message}`, 'error');
        updateResults(`<div class="status error"><strong>VERIFICATION ERROR:</strong> ${error.message}</div>`);
      }
    }

    async function testDownload() {
      log('üì• Testing PDF download functionality...', 'info');
      
      try {
        // Create download link
        const link = document.createElement('a');
        link.href = '/whitepaper.pdf';
        link.download = 'Protocol_402_SCETA_Whitepaper.pdf';
        link.style.display = 'none';
        document.body.appendChild(link);
        
        log('üîó Triggering download...', 'info');
        link.click();
        document.body.removeChild(link);
        
        log('‚úÖ Download triggered successfully', 'success');
        updateResults('<div class="status success"><strong>DOWNLOAD TRIGGERED:</strong> Check your downloads folder.</div>');
        
      } catch (error) {
        log(`‚ùå Download test error: ${error.message}`, 'error');
        updateResults(`<div class="status error"><strong>DOWNLOAD ERROR:</strong> ${error.message}</div>`);
      }
    }

    async function testFormSubmission() {
      log('üìù Testing complete form submission + download flow...', 'info');
      
      try {
        const testData = new FormData();
        testData.append('name', 'Test User');
        testData.append('email', 'test@example.com');
        testData.append('TIMESTAMP', new Date().toISOString());
        
        log('üì§ Submitting to Sheet.best API...', 'info');
        const response = await fetch('https://api.sheetbest.com/sheets/07bd8119-35d1-486f-9b88-8646578c0ef9', {
          method: 'POST',
          body: testData
        });
        
        if (response.ok) {
          log('‚úÖ Form submission successful', 'success');
          
          // Test PDF download after form submission
          setTimeout(() => {
            log('üîó Testing PDF download after form submission...', 'info');
            window.open('/whitepaper.pdf', '_blank');
            log('‚úÖ PDF download triggered after form submission', 'success');
            updateResults('<div class="status success"><strong>FULL FLOW TESTED:</strong> Form submission + PDF download completed.</div>');
          }, 1000);
          
        } else {
          throw new Error(`Sheet.best API error: ${response.status}`);
        }
        
      } catch (error) {
        log(`‚ùå Form submission test error: ${error.message}`, 'error');
        updateResults(`<div class="status error"><strong>FORM TEST ERROR:</strong> ${error.message}</div>`);
      }
    }

    // Auto-run verification when page loads
    window.addEventListener('load', () => {
      log('üöÄ PDF Verification System loaded', 'info');  
      log(`üì± Device: ${navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop'}`, 'info');
      
      // Auto-verify PDF
      setTimeout(verifyPDF, 1000);
    });
  </script>
</body>
</html>
